import Head from 'next/head'
import { useEffect, useState, useRef, useLayoutEffect } from 'react'
import { fetchData } from '../libs/FethData';
import { Codes } from '../libs/CodeFlags';

import html2canvas from 'html2canvas';

export default function Home() {

  const [historica, setHistorica] = useState();

  useEffect(() => {

    const AirtableData = async () => {

      const dataResponse = await fetchData('https://api.airtable.com/v0/app6QkHya20rCFqu4/tbl6L53IbxznTdJxS?maxRecords=1&sort%5B0%5D%5Bdirection%5D=asc&sort%5B0%5D%5Bfield%5D=id&filterByFormula=stateSeen=FALSE()', {
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${process.env.NEXT_PUBLIC_AIRTABLE_TOKEN}`
        }
      });

      const Today = dataResponse.records[0];
      let flag = Codes.filter((item) => item.name === Today.fields.country)[0].code
      Today.fields.country = flag;
      setHistorica(Today);

    }
    AirtableData();

  }, []);

  const share = async (event) => {

    let elementHTML = event.target.parentElement.childNodes[0]

    const canvasStory = await html2canvas(elementHTML, {
      letterRendering: 1,
      allowTaint: true,
      useCORS: true,
    });

    // document.body.appendChild(canvasStory);

    const dataUrl = canvasStory.toDataURL();
    const blob = await (await fetch(dataUrl)).blob();

    const filesArray = [
      new File(
        [blob],
        'historica.png',
        {
          type: blob.type,
          lastModified: new Date().getTime()
        }
      )
    ];

    const shareData = {
      files: filesArray,
      url: 'http://localhost:3000'
    };

    navigator.share(shareData);
  }

  const download = async (event) => {

    let elementHTML = event.target.parentElement.childNodes[0]

    const canvasStory = await html2canvas(elementHTML, {
      letterRendering: 1,
      allowTaint: true,
      useCORS: true,
    });

    const dataUrl = canvasStory.toDataURL();
    const blob = await (await fetch(dataUrl)).blob();

    const filesArray = [
      new File(
        [blob],
        'historica.png',
        {
          type: blob.type,
          lastModified: new Date().getTime()
        }
      )
    ];

    let link = document.createElement('a');
    link.download = 'historica.png';
    link.href = dataUrl;
    link.click();
  }

  return (
    <>
      <Head>
        <title>Hist√≥ricas {historica && `| ${historica.fields.fullname}`}</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
      </Head>
      <main>
        <section style={{ width: '400px', margin: '0 auto' }}>
          <div id='capture'>
            {
              historica && (
                <>
                  <img width={250} src={historica.fields.photo} alt={historica.fields.fullname} />
                  <h1>{historica.fields.fullname}</h1>
                  <img
                    src={`https://flagcdn.com/w80/${historica.fields.country.toLocaleLowerCase()}.png`}
                    alt={historica.fields.country} />
                  <p>{historica.fields.description}</p>
                </>
              )
            }
          </div>
          <button onClick={(event) => share(event)}>Compartir</button>
          <button onClick={(event) => download(event)}>Descargar</button>
        </section>
        <section id="result"></section>
      </main>
    </>
  )
}
